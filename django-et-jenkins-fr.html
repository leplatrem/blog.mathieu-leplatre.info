<!DOCTYPE html>
<html lang="en">
<head>
        <title>Django et Jenkins - Mathieu Leplatre</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://blog.mathieu-leplatre.info/theme/css/main.css" type="text/css" />
        <link href="https://blog.mathieu-leplatre.info/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Mathieu Leplatre ATOM Feed" />
</head>
<body>
        <section id="links">
            <li>
                <a class="" href="https://blog.mathieu-leplatre.info/" id="site-title">Blog</a>
            </li>
                <li><a class="" href="https://blog.mathieu-leplatre.info/pages/about.html">About</a></li>
        </section>
<header>
    <h1>Django et Jenkins</h1>
<time datetime="2011-04-28T17:25:00+02:00">Thu 28 April 2011</time></header>
<article>
    <p><em>Article original publié chez</em> <a class="reference external" href="http://makina-corpus.org">Makina Corpus</a></p>
<p>Lors des <a class="reference external" href="http://rencontres.django-fr.org/2011/">Recontres Django 2011</a>, <a class="reference external" href="http://www.akei.com">Nicolas Perriault</a> a présenté les principes de l'<a class="reference external" href="http://fr.wikipedia.org/wiki/Int%C3%A9gration_continue">intégration continue</a> avec <a class="reference external" href="http://djangoproject.com">Django</a> et <a class="reference external" href="http://jenkins-ci.org/">Jenkins</a>.</p>
<p>Le diaporama, <a class="reference external" href="http://www.akei.com/presentations/2011-Djangocong/index.html">disponible en ligne</a>, suffit amplement pour démarrer !</p>
<p>Mais pour qu'un projet django soit testé facilement, il doit se déployer et se lancer facilement ! C'est certes l'occasion de peaufiner l'automatisation, mais c'est loin d'être trivial quand il y a du SIG, du <a class="reference external" href="http://celeryproject.org">celery</a> ...
Je vais tenter de partager mes notes dans ce billet.</p>
<div class="section" id="le-minimum-requis">
<h2>Le minimum requis</h2>
<p>Pour l'installation de Jenkins, rien de plus simple (<em>sur debian</em>)</p>
<pre class="literal-block">
sudo aptitude install jenkins
</pre>
<p>Mais il va falloir lui donner de quoi télécharger votre code sur <cite>git</cite> et parfois compiler les librairies python nécessaires</p>
<pre class="literal-block">
sudo aptitude install git-core
sudo aptitude install python-dev build-essential python-virtualenv
</pre>
<p>Les plugins indispensables :</p>
<ul class="simple">
<li>covertura</li>
<li>Violations</li>
<li>GIT</li>
<li>Green Balls</li>
<li>Continuous Integration Game</li>
</ul>
</div>
<div class="section" id="organisation-du-projet-django">
<h2>Organisation du projet Django</h2>
<ul>
<li><p class="first">Définition des dépendances globales dans <cite>requirements.txt</cite></p>
<pre class="literal-block">
Django&gt;=1.3
south
</pre>
</li>
<li><p class="first">Définition des dépendances liées aux tests dans <cite>requirements-testing.txt</cite></p>
<pre class="literal-block">
django-jenkins
</pre>
</li>
<li><p class="first">Ajout d'un fichier <cite>pylint.rc</cite> pour régler les niveaux d'alerte <a class="reference external" href="http://www.python.org/dev/peps/pep-0008/">PEP-8</a></p>
<pre class="literal-block">
[MESSAGES CONTROL]
disable=E1101,E1103,C0111,I0011,I0012,W0704,W0142,W0212,W0232,W0613,W0702,R0201
...
...
</pre>
</li>
<li><p class="first">Modèle de settings de tests dans <cite>project/test_settings.py</cite></p>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">default_settings</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">TEMPLATE_DEBUG</span> <span class="o">=</span> <span class="n">DEBUG</span>

<span class="n">INSTALLED_APPS</span> <span class="o">+=</span> <span class="p">(</span>
    <span class="s1">&#39;django_jenkins&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">PYLINT_RCFILE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_ROOT_PATH</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;conf&#39;</span><span class="p">,</span> <span class="s1">&#39;pylint.rc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="configuration-du-job-jenkins">
<h2>Configuration du job Jenkins</h2>
<p>Les informations de la présentation de Nicolas suffisent pour démarrer.</p>
<p>J'ai noté cependant qu'il fallait lancer <cite>manage.py</cite> depuis un répertoire parent au projet pour que l'exploration du code source fonctionne.</p>
<p>Pour profiter de la magie des ingrédients précédents, nous aurons donc juste à ajouter un bloc script shell, qui installe les dépendances listées, pose les settings de test et migre la base (avec <a class="reference external" href="http://south.aeracode.org">South</a>):</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash -ex</span>
virtualenv<span class="w"> </span>--quiet<span class="w"> </span>ve
<span class="nb">source</span><span class="w"> </span>./ve/bin/activate
pip<span class="w"> </span>install<span class="w"> </span>-E<span class="w"> </span>./ve<span class="w"> </span>-r<span class="w"> </span><span class="nv">$WORKSPACE</span>/requirements.txt
pip<span class="w"> </span>install<span class="w"> </span>-E<span class="w"> </span>./ve<span class="w"> </span>-r<span class="w"> </span><span class="nv">$WORKSPACE</span>/requirements-testing.txt
cp<span class="w"> </span><span class="nv">$WORKSPACE</span>/project/test_settings.py<span class="w"> </span><span class="nv">$WORKSPACE</span>/project/local_settings.py
python<span class="w"> </span><span class="nv">$WORKSPACE</span>/project/manage.py<span class="w"> </span>syncdb<span class="w"> </span>--noinput
python<span class="w"> </span><span class="nv">$WORKSPACE</span>/project/manage.py<span class="w"> </span>migrate
deactivate
</pre></div>
<p>et celui-ci pour lancer les tests proprements dits :</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash -ex</span>
virtualenv<span class="w"> </span>--quiet<span class="w"> </span>ve
<span class="nb">source</span><span class="w"> </span>./ve/bin/activate
python<span class="w"> </span><span class="nv">$WORKSPACE</span>/project/manage.py<span class="w"> </span>jenkins<span class="w"> </span>yourapps
deactivate
</pre></div>
</div>
<div class="section" id="pour-un-projet-sig">
<h2>Pour un projet SIG</h2>
<p>Il faut installer certaines librairies SIG sur le serveur Jenkins.</p>
<div class="highlight"><pre><span></span>sudo<span class="w"> </span>aptitude<span class="w"> </span>install<span class="w"> </span>libproj0<span class="w"> </span>libgeos-c1
</pre></div>
<p>Si le besoin de cloisonner ces librairies pour chaque projet se fait ressentir, il faut utiliser des outils comme <a class="reference external" href="http://www.minitage.org">minitage</a>.</p>
<div class="section" id="spatialite-au-lieu-de-postgis-comme-base-de-tests">
<h3>Spatialite au lieu de PostGIS comme base de tests</h3>
<div class="highlight"><pre><span></span>sudo<span class="w"> </span>aptitude<span class="w"> </span>install<span class="w"> </span>python-sqlite<span class="w"> </span>libspatialite2<span class="w"> </span>sqlite3
</pre></div>
<p>Script d'initialisation</p>
<div class="highlight"><pre><span></span>wget<span class="w"> </span>http://www.gaia-gis.it/spatialite/init_spatialite-2.3.zip<span class="w"> </span>-O<span class="w"> </span>/tmp/init_spatialite-2.3.zip
<span class="nb">cd</span><span class="w"> </span>/usr/local/lib/
sudo<span class="w"> </span>unzip<span class="w"> </span>/tmp/init_spatialite-2.3.zip
</pre></div>
<p>avec dans <cite>test_settings.py</cite></p>
<div class="highlight"><pre><span></span><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
<span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;django.contrib.gis.db.backends.spatialite&#39;</span><span class="p">,</span>
    <span class="o">...</span>
    <span class="o">...</span>

<span class="n">SPATIALITE_SQL</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;usr&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;lib&#39;</span><span class="p">,</span> <span class="s1">&#39;init_spatialite-2.3.sql&#39;</span><span class="p">)</span>
</pre></div>
<p>Si pysqlite n'a pas été compilé avec les extensions C (Erreur: <em>The pysqlite library does not support C extension loading.</em>) il va falloir le recompiler !</p>
<div class="highlight"><pre><span></span>sudo<span class="w"> </span>aptitude<span class="w"> </span>install<span class="w"> </span>libsqlite3-dev
wget<span class="w"> </span>http://pysqlite.googlecode.com/files/pysqlite-2.6.3.tar.gz
tar<span class="w"> </span>-zxvf<span class="w"> </span>pysqlite-2.6.3.tar.gz
<span class="nb">cd</span><span class="w"> </span>pysqlite-2.6.3
sed<span class="w"> </span>-i<span class="w"> </span>s/define<span class="o">=</span>SQLITE_OMIT_LOAD_EXTENSION/#define<span class="o">=</span>SQLITE_OMIT_LOAD_EXTENSION/g<span class="w"> </span>setup.cfg

<span class="nb">source</span><span class="w"> </span>./ve/bin/activate
python<span class="w"> </span>setup.py<span class="w"> </span>install
</pre></div>
</div>
</div>
<div class="section" id="pour-un-projet-celery">
<h2>Pour un projet Celery</h2>
<div class="section" id="kombu-au-lieu-de-rabbitmq-comme-gestionnaire-de-messages">
<h3>Kombu au lieu de RabbitMQ comme gestionnaire de messages</h3>
<p><cite>requirements-testing.txt</cite></p>
<pre class="literal-block">
kombu
djkombu
</pre>
<p><cite>test_settings.py</cite></p>
<div class="highlight"><pre><span></span><span class="n">INSTALLED_APPS</span> <span class="o">+=</span> <span class="p">(</span>
    <span class="s1">&#39;djkombu&#39;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">CARROT_BACKEND</span> <span class="o">=</span> <span class="s2">&quot;django&quot;</span>
</pre></div>
<p>Pour désactiver la parallélisation lors des tests</p>
<div class="highlight"><pre><span></span><span class="n">CELERY_ALWAYS_EAGER</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>

	<p>
        <a href="https://blog.mathieu-leplatre.info/tag/django.html">#django</a>,         <a href="https://blog.mathieu-leplatre.info/tag/jenkins.html">#jenkins</a>,         <a href="https://blog.mathieu-leplatre.info/tag/continuous-integration.html">#continuous integration</a>	  - Posted in the <a href="https://blog.mathieu-leplatre.info/category/dev.html">Dev</a> category
	</p>
  <hr>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function() {
      this.page.url = 'https://blog.mathieu-leplatre.info/django-et-jenkins-fr.html';
      this.page.identifier = 'django-et-jenkins';
    };
    (function() {
      var d = document;
      var s = d.createElement('script');
      s.src = '//mathieuleplatre.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript class="text-muted">
    Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
  </noscript>
</article>

        <footer>
            <p>
                © Copyright 2020 by Mathieu Leplatre. <a href="http://mathieu.agopian.info/mnmlist/theme.html">mnmlist Theme</a>
            </p>
            <p>Content licensed under the Creative Commons attribution-noncommercial-sharealike License. </p>
        </footer>
</body>
</html>