<!DOCTYPE html>
<html lang="en">
<head>
        <title>Django : Create a QuerySet from a list, preserving order - Mathieu Leplatre</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://blog.mathieu-leplatre.info/theme/css/main.css" type="text/css" />
        <link href="https://blog.mathieu-leplatre.info/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Mathieu Leplatre ATOM Feed" />
</head>
<body>
        <section id="links">
            <li>
                <a class="" href="https://blog.mathieu-leplatre.info/" id="site-title">Blog</a>
            </li>
                <li><a class="" href="https://blog.mathieu-leplatre.info/pages/about.html">About</a></li>
        </section>
<header>
    <h1>Django : Create a QuerySet from a list, preserving order</h1>
<time datetime="2013-11-08T00:00:00+01:00">Fri 08 November 2013</time></header>
<article>
    <p>I thought it would be an easy one, but found myself lost with 34 opened tabs
on <em>stackoverflow</em>...</p>
<div class="section" id="the-problem-keep-it-ordered">
<h2>The problem : keep it ordered</h2>
<p>Usually, obtaining a <tt class="docutils literal">QuerySet</tt> from a list is quite simple :</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt;<span class="w"> </span><span class="nv">queryset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Theme.objects.filter<span class="o">(</span><span class="nv">pk__in</span><span class="o">=[</span><span class="m">1</span>,<span class="w"> </span><span class="m">2</span>,<span class="w"> </span><span class="m">10</span><span class="o">])</span>
&gt;&gt;&gt;<span class="w"> </span>type<span class="o">(</span>queryset<span class="o">)</span>
&lt;class<span class="w"> </span><span class="s1">&#39;django.db.models.query.QuerySet&#39;</span>&gt;
&gt;&gt;&gt;<span class="w"> </span>queryset
<span class="o">[</span>&lt;Theme:<span class="w"> </span>Fauna&gt;,<span class="w"> </span>&lt;Theme:<span class="w"> </span>Flora&gt;,<span class="w"> </span>&lt;Theme:<span class="w"> </span>Refuge&gt;<span class="o">]</span>
</pre></div>
<p>The problem is that the list order is ignored :</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt;<span class="w"> </span>Theme.objects.filter<span class="o">(</span><span class="nv">pk__in</span><span class="o">=[</span><span class="m">10</span>,<span class="w"> </span><span class="m">2</span>,<span class="w"> </span><span class="m">1</span><span class="o">])</span>
<span class="o">[</span>&lt;Theme:<span class="w"> </span>Fauna&gt;,<span class="w"> </span>&lt;Theme:<span class="w"> </span>Flora&gt;,<span class="w"> </span>&lt;Theme:<span class="w"> </span>Refuge&gt;<span class="o">]</span>
</pre></div>
<p>If obtaining a <tt class="docutils literal">QuerySet</tt> is not a requirement, it's <a class="reference external" href="http://stackoverflow.com/a/7361598/141895">rather easy to get a list sorted</a>
according to another :</p>
<div class="highlight"><pre><span></span><span class="n">pks_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">themes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Theme</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">pks_list</span><span class="p">))</span>
<span class="n">themes</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">pks_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
</pre></div>
<p>In my case, I want a <tt class="docutils literal">QuerySet</tt>, a brave lazy one, with proper <tt class="docutils literal">filter()</tt>,
<tt class="docutils literal">exclude()</tt>, <tt class="docutils literal">values()</tt> ...</p>
</div>
<div class="section" id="fallback-to-sql">
<h2>Fallback to SQL</h2>
<p>AFAIK, most database engines ignore order of records, until you specify an
ordering column. In our case, the list is arbitrary, and does not map to any
existing attribute, thus db column.</p>
<p>If you use MySQL (<em>who does?!</em>), there is a <tt class="docutils literal">FIELD()</tt> function that provides
<a class="reference external" href="http://stackoverflow.com/a/3626200/141895">custom input for the sort method</a> :</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">theme</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">FIELD</span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</pre></div>
<p>Using the ORM, it gives us (<em>thanks Daniel Roseman</em>)</p>
<div class="highlight"><pre><span></span><span class="n">pk_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">ordering</span> <span class="o">=</span> <span class="s1">&#39;FIELD(`id`, </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">pk_list</span><span class="p">)</span>
<span class="n">queryset</span> <span class="o">=</span> <span class="n">Theme</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="p">[</span><span class="n">pk_list</span><span class="p">])</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span>
           <span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ordering&#39;</span><span class="p">:</span> <span class="n">ordering</span><span class="p">},</span> <span class="n">order_by</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ordering&#39;</span><span class="p">,))</span>
</pre></div>
<p>Well, good news it can be <a class="reference external" href="http://stackoverflow.com/questions/1309624/simulating-mysqls-order-by-field-in-postgresql">ported to PostgreSQL</a>.
But if possible, I would prefer native SQL.</p>
<p>And it looks like the magnificient syntax of SQL provides <tt class="docutils literal">ORDER BY CASE WHEN ... END</tt> !</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">theme</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span>
<span class="w">  </span><span class="k">CASE</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="mi">10</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="mi">2</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">2</span>
<span class="w">  </span><span class="k">END</span><span class="p">;</span>
</pre></div>
<p>Using the ORM, it gives us :</p>
<div class="highlight"><pre><span></span><span class="n">pk_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">clauses</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;WHEN id=</span><span class="si">%s</span><span class="s1"> THEN </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pk</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pk_list</span><span class="p">)])</span>
<span class="n">ordering</span> <span class="o">=</span> <span class="s1">&#39;CASE </span><span class="si">%s</span><span class="s1"> END&#39;</span> <span class="o">%</span> <span class="n">clauses</span>
<span class="n">queryset</span> <span class="o">=</span> <span class="n">Theme</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">pk_list</span><span class="p">)</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span>
           <span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ordering&#39;</span><span class="p">:</span> <span class="n">ordering</span><span class="p">},</span> <span class="n">order_by</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ordering&#39;</span><span class="p">,))</span>
</pre></div>
<p>I wonder how it behaves with zillions of records though ;)</p>
<p>One more thing: before Django 1.6, there <a class="reference external" href="https://code.djangoproject.com/ticket/14930">was a bug</a> with calling <tt class="docutils literal">values_list()</tt>
on a queryset ordered by an extra column. Use this :</p>
<div class="highlight"><pre><span></span><span class="n">values</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;ordering&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
</pre></div>
<p>Good luck ! Please share your advices or critics ;)</p>
</div>

	<p>
        <a href="https://blog.mathieu-leplatre.info/tag/django.html">#django</a>	  - Posted in the <a href="https://blog.mathieu-leplatre.info/category/dev.html">Dev</a> category
	</p>
  <hr>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function() {
      this.page.url = 'https://blog.mathieu-leplatre.info/django-create-a-queryset-from-a-list-preserving-order.html';
      this.page.identifier = 'django-create-a-queryset-from-a-list-preserving-order';
    };
    (function() {
      var d = document;
      var s = d.createElement('script');
      s.src = '//mathieuleplatre.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript class="text-muted">
    Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
  </noscript>
</article>

        <footer>
            <p>
                Â© Copyright 2020 by Mathieu Leplatre. <a href="http://mathieu.agopian.info/mnmlist/theme.html">mnmlist Theme</a>
            </p>
            <p>Content licensed under the Creative Commons attribution-noncommercial-sharealike License. </p>
        </footer>
</body>
</html>